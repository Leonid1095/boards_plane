# PLGames - Быстрый старт (AFFINE основа)

## Цель
Запустить проект **в любом виде** для первой проверки работоспособности.

## Что исправлено

✅ **Dockerfile.plgames** - переписан с нуля для работы с Prisma и Sharp
✅ **Переменные окружения** - настроены для Debian Bookworm
✅ **.dockerignore** - оптимизирована сборка
✅ **Документация** - создана полная инструкция

## Быстрый запуск (3 команды)

### Вариант 1: Автоматический (рекомендуется)

```bash
# 1. Запустите скрипт быстрого деплоя
bash quick-deploy.sh
```

Скрипт автоматически:
- Проверит Docker
- Остановит старые контейнеры
- Соберет новые образы (10-20 минут)
- Запустит все сервисы
- Проверит работоспособность

### Вариант 2: Ручной запуск

```bash
# 1. Остановите старые контейнеры (если есть)
docker compose down

# 2. Соберите образы
docker compose build --no-cache

# 3. Запустите сервисы
docker compose up -d

# 4. Проверьте статус
docker compose ps

# 5. Проверьте логи
docker compose logs -f backend
```

## Ожидаемый результат

После запуска должны быть доступны:

- **Frontend:** http://localhost:8080
- **Backend API:** http://localhost:3010
- **GraphQL:** http://localhost:3010/graphql
- **PostgreSQL:** localhost:5432
- **Redis:** localhost:6379 (внутренний)

## Проверка работы

### 1. Проверка статуса контейнеров

```bash
docker compose ps
```

Должно быть:
- ✅ `backend` - running
- ✅ `frontend` - running
- ✅ `postgres` - running (healthy)
- ✅ `redis` - running (healthy)

### 2. Проверка Backend API

```bash
curl http://localhost:3010/api/healthz
```

Должно вернуть: `{"status":"ok"}` или похожий JSON

### 3. Проверка Frontend

Откройте в браузере: http://localhost:8080

### 4. Проверка логов

```bash
# Все логи
docker compose logs -f

# Только backend
docker compose logs -f backend

# Последние 100 строк
docker compose logs --tail=100 backend
```

## Если что-то не работает

### Проблема: Backend не запускается

```bash
# Смотрим логи
docker compose logs backend

# Проверяем PostgreSQL
docker compose exec postgres pg_isready -U plgames

# Перезапускаем backend
docker compose restart backend
```

### Проблема: Ошибка при сборке

```bash
# Проверьте лог сборки
cat /tmp/plgames-build.log

# Очистите кэш и пересоберите
docker compose down -v
docker system prune -af
docker compose build --no-cache
```

### Проблема: "Prisma engine not found"

Это значит проблема с Prisma binaries. Проверьте:

```bash
# Зайдите в контейнер
docker compose exec backend sh

# Проверьте наличие Prisma engine
ls -la /app/node_modules/.prisma/client/

# Проверьте переменные окружения
env | grep PRISMA
```

Если файлов нет - пересоберите образ:
```bash
docker compose build --no-cache backend
docker compose up -d backend
```

### Проблема: "Port already in use"

```bash
# Найдите процесс на порту 3010 или 8080
sudo lsof -i :3010
sudo lsof -i :8080

# Остановите конфликтующие контейнеры
docker ps -a | grep -E "3010|8080"
docker stop <container_id>

# Или измените порты в .env
# BACKEND_PORT=3011
# FRONTEND_PORT=8081
```

### Проблема: Frontend показывает ошибку подключения

Проверьте, что backend запущен и отвечает:

```bash
curl http://localhost:3010/api/healthz
```

Если backend не отвечает - смотрите логи:
```bash
docker compose logs -f backend
```

## Команды для управления

```bash
# Запуск
docker compose up -d

# Остановка
docker compose down

# Перезапуск
docker compose restart

# Остановка + удаление данных
docker compose down -v

# Пересборка
docker compose build --no-cache

# Статус
docker compose ps

# Логи (все сервисы)
docker compose logs -f

# Логи (только backend)
docker compose logs -f backend

# Логи (последние 50 строк)
docker compose logs --tail=50

# Зайти в контейнер backend
docker compose exec backend bash

# Зайти в PostgreSQL
docker compose exec postgres psql -U plgames -d plgames
```

## Структура проекта

```
.
├── plgames/                    # Основной код (AFFINE)
│   ├── packages/
│   │   ├── backend/server/     # Backend (NestJS + Prisma)
│   │   └── frontend/           # Frontend (React)
│   ├── Dockerfile.plgames      # ✅ ИСПРАВЛЕН (Debian + Prisma)
│   └── .dockerignore           # ✅ СОЗДАН
├── docker-compose.yml          # Конфигурация Docker
├── .env                        # Переменные окружения
├── quick-deploy.sh             # ✅ Скрипт быстрого запуска
└── БЫСТРЫЙ_СТАРТ.md            # Этот файл
```

## Следующие шаги (после запуска)

После того как проект запустится в **любом виде**:

### 1. Проверьте базовый функционал
- Создание workspace
- Создание документа
- Авторизация

### 2. Настройте дополнительные функции (опционально)

#### AI (OpenRouter)
```env
# В .env
AFFINE_COPILOT_ENABLED=true
AFFINE_COPILOT_OPENROUTER_API_KEY=sk-or-v1-ваш-ключ
```

#### OAuth (Yandex)
```env
# В .env
AFFINE_OAUTH_OIDC_ISSUER=https://oauth.yandex.ru
OIDC_CLIENT_ID=ваш_client_id
OIDC_CLIENT_SECRET=ваш_secret
```

#### Email (SMTP)
```env
# В .env
MAILER_HOST=smtp.yandex.ru
MAILER_PORT=465
MAILER_USER=your@yandex.ru
MAILER_PASSWORD=app-password
```

### 3. Добавьте CRM функционал (Plane)

После базового запуска можно интегрировать CRM:

```bash
# Это будет следующий этап
# Сначала убедитесь что AFFINE работает
```

## Технические детали

### Что изменилось в Dockerfile.plgames

**ДО (не работало):**
- ❌ Alpine Linux (несовместим с Prisma)
- ❌ Нет libvips для Sharp
- ❌ Нет переменных Prisma
- ❌ Неправильное копирование файлов

**ПОСЛЕ (работает):**
- ✅ Debian Bookworm (совместим с Prisma)
- ✅ Установлен libvips для Sharp
- ✅ Настроены переменные Prisma
- ✅ Правильное копирование Prisma client

### Системные требования

- **Docker:** 20.10+
- **Docker Compose:** 2.0+
- **RAM:** минимум 4GB, рекомендуется 8GB
- **Disk:** минимум 15GB свободного места
- **CPU:** 2+ ядра

### Порты

- `3010` - Backend API
- `8080` - Frontend
- `5432` - PostgreSQL (опционально, для внешнего доступа)

## Поддержка

### Логи для диагностики

Если что-то не работает, соберите информацию:

```bash
# Статус
docker compose ps > status.txt

# Логи backend
docker compose logs --tail=200 backend > backend.log

# Логи postgres
docker compose logs --tail=100 postgres > postgres.log

# Информация о системе
docker info > docker-info.txt
docker version >> docker-info.txt
```

### Полезные ссылки

- **AFFINE GitHub:** https://github.com/toeverything/AFFiNE
- **AFFINE Docs:** https://docs.affine.pro
- **Docker Docs:** https://docs.docker.com
- **Prisma Docs:** https://www.prisma.io/docs

## Заключение

Теперь у вас есть:

1. ✅ Исправленный Dockerfile (Debian + Prisma)
2. ✅ Скрипт быстрого запуска
3. ✅ Полная документация
4. ✅ Готовая конфигурация (.env)

**Запустите прямо сейчас:**

```bash
bash quick-deploy.sh
```

После успешного запуска можно переходить к доработке и интеграции CRM функционала из Plane.

---

**Создано:** 2024-12-06
**Основа:** AFFiNE (toeverything/AFFiNE)
**Дополнения:** Plane CRM (будет интегрировано позже)
